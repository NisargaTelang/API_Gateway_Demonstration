version: "3.9"

services:
  db:
    image: postgres:16
    container_name: db
    environment:
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_DB: ${POSTGRES_DB}
    healthcheck:
      test: [ "CMD-SHELL", "pg_isready -U ${POSTGRES_USER} -d ${POSTGRES_DB}" ]
      interval: 5s
      timeout: 3s
      retries: 30
    ports:
      - "${PG_PORT}:5432"
    volumes:
      - db-data:/var/lib/postgresql/data
    networks: [ app-net ]

  redis:
    image: redis:7-alpine
    container_name: redis
    ports:
      - "${REDIS_PORT}:6379"
    networks: [ app-net ]

  # -------- Spring services --------
  auth-service:
    build: ./Auth-service
    container_name: auth-service
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${POSTGRES_DB}
      DB_USERNAME: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      # For CORS if you use it in Spring
      FRONTEND_ORIGIN: http://localhost:${FRONTEND_PORT}
    depends_on:
      db:
        condition: service_healthy
    networks: [ app-net ]

  product-service:
    build: ./Product-service
    container_name: product-service
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${POSTGRES_DB}
      DB_USERNAME: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      # Where to store product images inside container
      APP_UPLOAD_BASE_PATH: /data/
      APP_IMAGES_FOLDER: products/
      # Public URL SHOULD be through gateway so the browser can fetch it
      APP_BASE_URL: http://localhost:${GATEWAY_PORT}/files/
    volumes:
      - ${HOST_PRODUCTS_DIR}:/data/products
    depends_on:
      db:
        condition: service_healthy
    networks: [ app-net ]

  order-service:
    build: ./Order-service
    container_name: order-service
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${POSTGRES_DB}
      DB_USERNAME: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      # Talk to other services via **service names** & internal ports
      PRODUCT_BASE_URL: http://product-service:8081/products
      PAYMENT_BASE_URL: http://payment-service:8083/payments
    depends_on:
      db:
        condition: service_healthy
      product-service:
        condition: service_started
    networks: [ app-net ]

  payment-service:
    build: ./Payment-service
    container_name: payment-service
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: ${POSTGRES_DB}
      DB_USERNAME: ${POSTGRES_USER}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      JWT_SECRET: ${JWT_SECRET}
      ORDER_SERVICE_URL: http://order-service:8082/orders
      PRODUCT_SERVICE_URL: http://product-service:8081/products
      # PDF storage inside container + public link via gateway
      PAYMENT_PDF_STORAGE_PATH: /data/bills/
      PAYMENT_PDF_BASE_URL: http://localhost:${GATEWAY_PORT}/payments/bills/
    volumes:
      - ${HOST_BILLS_DIR}:/data/bills
    depends_on:
      db:
        condition: service_healthy
      order-service:
        condition: service_started
    networks: [ app-net ]

  # -------- API Gateway (Node+TS) --------
  api-gateway:
    build: ./API-gateway
    container_name: api-gateway
    environment:
      JWT_SECRET: ${JWT_SECRET}
      CORS_ORIGINS: http://localhost:${FRONTEND_PORT}
    volumes:
      - ${HOST_PRODUCTS_DIR}:/data/products
      - ${HOST_BILLS_DIR}:/data/bills
    env_file: ./API-gateway/.env # provided below
    ports:
      - "${GATEWAY_PORT}:3000"
    depends_on:
      - auth-service
      - product-service
      - payment-service
      - order-service
      - redis
    networks: [ app-net ]

  # -------- Frontend (Vite -> Nginx) --------
  frontend:
    build:
      context: ./E-Commerce
      dockerfile: Dockerfile
      args:
        VITE_AUTH_BASE_URL: http://localhost:${GATEWAY_PORT}/auth
        VITE_PRODUCT_BASE_URL: http://localhost:${GATEWAY_PORT}/products
        VITE_ORDER_BASE_URL: http://localhost:${GATEWAY_PORT}/orders
        VITE_PAYMENT_BASE_URL: http://localhost:${GATEWAY_PORT}/payments
    container_name: frontend
    ports:
      - "${FRONTEND_PORT}:80"
    depends_on:
      - api-gateway
    networks: [ app-net ]

volumes:
  db-data:


networks:
  app-net:
    driver: bridge
